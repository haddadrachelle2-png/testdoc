<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø³Ù„</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
</head>
<body class="p-4">

<div class="container">
    <h3>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø³Ù„</h3>

    <!-- Search Filters -->
    <div class="row mb-3">
        <div class="col-md-3">
           <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
            <input type="date" id="startDate" class="form-control">
        </div>
        <div class="col-md-3">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
            <input type="date" id="endDate" class="form-control">
        </div>
       <div class="col-md-3">
        <label>Ø§Ù„ÙˆØ¬Ù‡Ø©</label>
        <select class="form-control" id="adminFilterContainer">
        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
       </select>
       </div>

        <div class="col-md-3 align-self-end">
            <button id="searchBtn" class="btn btn-primary">Ø¨Ø­Ø«</button>
        </div>
    </div>

   <div class="d-flex justify-content-between gap-2 mt-3">
        <button id="downloadReport" class="btn btn-outline-primary">ðŸ“„ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF</button>
        <a href="index.html" class="btn btn-secondary">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
    </div>

    <!-- Sent Documents Table -->
    <table class="table table-bordered mt-2">
        <thead>
            <tr>
                <th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</th>
                <th>Ø§Ù„ÙˆØ¬Ù‡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="sentTable"></tbody>
    </table>

    
</div>

<script>
const token = localStorage.getItem("token");
if (!token) location.href="login.html";

const sentTable = document.getElementById("sentTable");
const groupFilter = document.getElementById("adminFilterContainer");

// Load sent documents
async function loadSentDocs() {
     try {
        const res = await fetch(`/api/documents/sent`, {
            headers: { "Authorization": "Bearer " + token }
        });
        
        if (!res.ok) {
            alert("Error loading documents");
            return;
        }

        allDocuments = await res.json();
        await populateGroupFilter();
        renderTable();

    } catch (err) {
        console.error(err);
        alert("Network error");
    }
}

// Populate group filter dropdown by fetching destinations for each document
async function populateGroupFilter() {
    const groupSet = new Set();
    
    for (const doc of allDocuments) {
        try {
            const destRes = await fetch(`/api/documents/${doc.id}/destinations`, {
                headers: { "Authorization": "Bearer " + token }
            });
            const dests = await destRes.json();
            dests.forEach(d => groupSet.add(d.name));
        } catch (err) {
            console.error('Error fetching destinations:', err);
        }
    }
    
    allGroups = Array.from(groupSet).sort();
    
    allGroups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        groupFilter.appendChild(option);
    });
}

// Render table with optional group filter
// Render table with optional group filter
async function renderTable() {
    
    const selectedGroup = groupFilter.value;
    let filteredDocs = allDocuments;

    sentTable.innerHTML = "";


    for(const doc of filteredDocs){
        // fetch destination names
        const destRes = await fetch(`/api/documents/${doc.id}/destinations`, {
            headers: {"Authorization":"Bearer "+token}
        });
        const dests = await destRes.json();
        const destNames = dests.map(d=>d.name).join(", ");
        
        // Filter by group if selected
        if (selectedGroup && !destNames.includes(selectedGroup)) {
            continue;
        }

        // Get creator's group name (using senderName which now contains group name from backend)
        const creatorGroup = doc.senderName || "N/A";
        
        sentTable.innerHTML += `
            <tr>
                <td>${doc.title}</td>
                <td>${new Date(doc.created_at).toLocaleString()}</td>
                <td>${new Date(doc.sent_at).toLocaleString()}</td>
                <td>${destNames}</td>
            </tr>
        `;
    }
}

// Search button
document.getElementById("searchBtn").addEventListener("click", renderTable);

// Initial load
loadSentDocs();

// Download PDF report
document.getElementById('downloadReport').addEventListener('click', async () => {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    let url = '/api/documents/sent/report';
    const params = [];
    if (start) params.push(`start=${start}`);
    if (end) params.push(`end=${end}`);
    if (params.length) url += '?' + params.join('&');

    // download by creating an anchor
    const a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    a.rel = 'noopener';
    // include token via header by fetching blob then creating object URL
    try {
        const res = await fetch(url, { headers: { 'Authorization': 'Bearer '+token } });
        if (!res.ok) {
            alert('Failed to generate report');
            return;
        }
        const blob = await res.blob();
        const blobUrl = URL.createObjectURL(blob);
        const dl = document.createElement('a');
        dl.href = blobUrl;
        dl.download = 'sent-documents-report.pdf';
        document.body.appendChild(dl);
        dl.click();
        dl.remove();
        URL.revokeObjectURL(blobUrl);
    } catch (err) {
        console.error(err);
        alert('Network error while generating report');
    }
});

 fetch("/api/users/me", {
        headers: { Authorization: "Bearer " + token },
      })
        .then((res) => {
          if (!res.ok) {
            logout();
            return;
          }
          return res.json();
        })
        .then((data) => {
         
    //       if (data.is_admin_group) {
    //   const adminLinks = document.getElementById("adminFilterContainer");
    // adminLinks.innerHTML = `
       
    //          <label>Destination Group</label>
    //          <select id="destFilter" class="form-control">
    //              <option value="">All Destinations</option>
    //          </select>
        
    // `;
    //      loadDestinationsForDropdown();
    //       }
        })
        .catch((err) => {
          console.error(err);
          logout();
        });

async function loadDestinationsForDropdown() {
    const url = `/api/documents/sent`;
    const res = await fetch(url, {
        headers: { Authorization: "Bearer " + token }
    });

    const docs = await res.json();
    const groupSet = new Set();

    for (const doc of docs) {
        const destRes = await fetch(`/api/documents/${doc.id}/destinations`, {
            headers: { Authorization: "Bearer " + token }
        });
        const dests = await destRes.json();
        dests.forEach(d => groupSet.add(d.name));
    }

    const destFilter = document.getElementById("destFilter");
    [...groupSet]
        .sort()
        .forEach(name => {
            destFilter.innerHTML += `<option value="${name}">${name}</option>`;
        });
}
</script>

</body>
</html>
