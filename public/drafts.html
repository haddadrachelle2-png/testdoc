<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>البريد غير المرسل</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css"
      rel="stylesheet"
    />

    <style>
      #pagination button {
        padding: 6px 12px;
        margin: 0 5px;
        font-size: 14px;
        cursor: pointer;
      }

      #pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #page-info {
        font-weight: bold;
        margin: 0 10px;
      }
    </style>
  </head>
  <body class="p-4">
    <div class="container">
      <h3>البريد غير المرسل</h3>

      <!-- Search Filters -->
      <div class="row mb-3">
        <div class="col-md-3">
          <label>تاريخ البدء</label>
          <input type="date" id="startDate" class="form-control" />
        </div>
        <div class="col-md-3">
          <label>تاريخ الانتهاء</label>
          <input type="date" id="endDate" class="form-control" />
        </div>
        <div class="col-md-3 align-self-end">
          <button id="searchBtn" class="btn btn-primary">بحث</button>
        </div>
      </div>

      <!-- Send Button -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="sendBtn" class="btn btn-success">
          إرسال البريد المحدد
        </button>

        <a href="index.html" class="btn btn-secondary"
          >⬅ العودة إلى لوحة التحكم</a
        >
      </div>

      <!-- Drafts Table -->
      <table class="table table-bordered mt-2">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" /></th>
            <th>الموضوع</th>
            <th>الرقم</th>
            <th>تاريخ المستند</th>
            <th>عدد الأوراق</th>
            <th>المرسل إليهم</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="draftTable"></tbody>
      </table>
    </div>
    <div id="drafts-container"></div>

    <div id="pagination" style="text-align: center; margin-top: 20px">
      <button id="prev-btn">السابق</button>
      <span
        >صفحة
        <input
          type="number"
          id="page-input"
          style="width: 50px; text-align: center"
          min="1"
        />
        من <span id="total-pages">1</span></span
      >
      <button id="next-btn">التالي</button>
    </div>
    <script>
      const token = localStorage.getItem("token");
      if (!token) location.href = "login.html";

      const draftTable = document.getElementById("draftTable");
      const prevBtn = document.getElementById("prev-btn");
      const nextBtn = document.getElementById("next-btn");
      const pageInput = document.getElementById("page-input");
      const totalPagesSpan = document.getElementById("total-pages");

      let currentPage = 1;
      let totalPages = 1;
      let selectedDrafts = new Set();

      // -------------------------
      // LOAD DRAFTS FUNCTION
      // -------------------------
      async function loadDrafts(page = 1) {
        const start = document.getElementById("startDate").value;
        const end = document.getElementById("endDate").value;

        let url = `/api/documents/drafts?page=${page}`;
        const params = [];
        if (start) params.push(`start=${start}`);
        if (end) params.push(`end=${end}`);
        if (params.length) url += "&" + params.join("&");

        const res = await fetch(url, {
          headers: { Authorization: "Bearer " + token },
        });

        const drafts = await res.json();
        draftTable.innerHTML = "";

        // No data
        if (!drafts.data || drafts.data.length === 0) {
          draftTable.innerHTML = `
      <tr><td colspan="7" class="text-center">لا توجد مسودات</td></tr>
    `;
          prevBtn.disabled = true;
          nextBtn.disabled = true;
          pageInput.value = 1;
          totalPagesSpan.textContent = 1;
          return;
        }

        // Fill table
        drafts.data.forEach((d) => {
          const checked = selectedDrafts.has(d.id) ? "checked" : "";
          draftTable.innerHTML += `
      <tr>
        <td> <input type="checkbox"
           class="draftCheckbox"
           data-id="${d.id}"
           ${checked}
           ${d.is_sent ? "disabled" : ""}></td>
        <td>${d.title}</td>
        <td>${d.doc_num}</td>
        <td>${
          d.doc_date ? new Date(d.doc_date).toLocaleDateString() : "N/A"
        }</td>
        <td>${d.number_papers}</td>
        <td>${d.destinations || "N/A"}</td>
        <td>
          ${
            d.is_sent
              ? ""
              : `<a href="create-document.html?id=${d.id}" class="btn btn-sm btn-primary">تعديل</a>`
          }
        </td>
      </tr>
    `;
        });

        // Update pagination
        currentPage = drafts.page || 1;
        totalPages = drafts.total_pages || 1;

        pageInput.value = currentPage;
        totalPagesSpan.textContent = totalPages;

        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        bindCheckboxEvents();
        updateSelectAllState();
      }

      // -------------------------
      // BUTTON EVENTS
      // -------------------------
      prevBtn.addEventListener("click", () => {
        if (currentPage > 1) loadDrafts(currentPage - 1);
      });

      nextBtn.addEventListener("click", () => {
        if (currentPage < totalPages) loadDrafts(currentPage + 1);
      });

      // -------------------------
      // TEXTBOX PAGE INPUT (no button)
      // -------------------------
      pageInput.addEventListener("change", () => {
        let page = parseInt(pageInput.value);

        if (isNaN(page) || page < 1) page = 1;
        if (page > totalPages) page = totalPages;

        loadDrafts(page);
      });

      // Search button resets to page 1
      document.getElementById("searchBtn").addEventListener("click", () => {
        loadDrafts(1);
      });

      // Send selected drafts
      document.getElementById("sendBtn").addEventListener("click", async () => {
        // const selected = Array.from(selectedDrafts);
        if (selectedDrafts.size === 0) {
          alert("Select at least one draft");
          return;
        }

        const res = await fetch("/api/documents/send", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ draftIds: Array.from(selectedDrafts) }),
        });

        const msg = await res.json();
        if (!res.ok) {
          alert(msg.message || "Error sending drafts");
        } else {
          alert(msg.message);
          selectedDrafts.clear();
          selectAll.checked = false;
          loadDrafts(1);
        }
      });

      // Initial load
      loadDrafts();
      function updateSelectAllState() {
        const boxes = document.querySelectorAll(
          ".draftCheckbox:not(:disabled)"
        );
        const checked = document.querySelectorAll(
          ".draftCheckbox:not(:disabled):checked"
        );

        selectAll.checked = boxes.length > 0 && boxes.length === checked.length;
      }
      const selectAll = document.getElementById("selectAll");

      selectAll.addEventListener("change", function () {
        const checked = this.checked;

        document.querySelectorAll(".draftCheckbox").forEach((cb) => {
          cb.checked = checked;
          const id = Number(cb.dataset.id);

          if (checked) {
            selectedDrafts.add(id);
          } else {
            selectedDrafts.delete(id);
          }
        });
      });
      function bindCheckboxEvents() {
        document.querySelectorAll(".draftCheckbox").forEach((cb) => {
          cb.addEventListener("change", function () {
            const id = Number(this.dataset.id);

            if (this.checked) {
              selectedDrafts.add(id);
            } else {
              selectedDrafts.delete(id);
            }

            updateSelectAllState();
          });
        });
      }
    </script>
  </body>
</html>
