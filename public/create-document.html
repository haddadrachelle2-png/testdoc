<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø¨Ø±ÙŠØ¯ Ø¬Ø¯ÙŠØ¯</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h3>Ø¨Ø±ÙŠØ¯ Ø¬Ø¯ÙŠØ¯</h3>
      <form id="docForm">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <button class="btn btn-primary">Ø­ÙØ¸</button>

          <a href="index.html" class="btn btn-secondary"  id="backBtn"
            >â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
          >
        </div>

        <div id="errorBox" class="alert alert-danger d-none"></div>
        <div id="successBox" class="alert alert-success d-none"></div>

        <div class="mb-3 d-flex align-items-center">
          <label class="form-label me-3" for="title">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
          <input
            id="title"
            class="form-control me-3"
            required
            style="flex: 1"
          />

          <!-- Personal Checkbox -->
          <div class="form-check mb-0">
            <input
              class="form-check-input"
              type="checkbox"
              id="personalDocument"
            />
            <label class="form-check-label" for="personalDocument">
              Ø´Ø®ØµÙŠ
            </label>
          </div>
        </div>

        <div class="mb-3 d-flex align-items-center gap-3">
          <!-- Doc Number -->
          <div class="d-flex flex-column" style="flex: 0 0 auto">
            <label class="form-label">Ø§Ù„Ø±Ù‚Ù…</label>
            <input
              id="doc_num"
              class="form-control me-3"
              type="text"
              style="max-width: 150px"
              required
            />
          </div>
          <div class="d-flex flex-column" style="flex: 0 0 auto">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</label>
            <input
              type="date"
              id="doc_date"
              class="form-control me-3"
              type="text"
              style="max-width: 150px"
              required
            />
          </div>

          <div class="d-flex flex-column" style="flex: 0 0 auto">
            <label class="form-label"> Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø±ÙÙ‚Ø©</label>
            <input
              id="number_papers"
              class="form-control me-3"
              type="text"
              style="max-width: 150px"
              required
            />
          </div>
        </div>

       <div class="mb-3 d-flex gap-3">
  <!-- Content textarea -->
  <div style="flex: 2">
    <label class="form-label">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
    <textarea id="content" class="form-control" rows="6" required></textarea>
  </div>

  <!-- Send options + Remarks -->
  <div style="flex: 1; display: flex; flex-direction: column; gap: 1rem;">
    <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
    <div class="mb-3">
      <label class="form-label fw-bold">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>

      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="send_paper" />
        <label class="form-check-label" for="send_paper">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ±Ù‚ÙŠ</label>
      </div>

      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="send_electronic" />
        <label class="form-check-label" for="send_electronic">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      </div>
    </div>

    <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
    <div class="mb-3">
      <label for="remarks" class="form-label fw-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <input type="text" id="remarks" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ù† ÙˆØ¬Ø¯Øª" />
    </div>
  </div>
</div>
       

        <div class="mb-3">
          <label class="form-label">Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù</label>
          <input
            type="file"
            name="attachment"
            
            id="attachment"
            class="form-control"
            accept="*/*"
          />
          
        </div>
         
  <div id="existingFile"></div>
    
        <div class="mb-3">
          <div class="form-check mb-2">
            <input
              class="form-check-input"
              type="checkbox"
              id="selectAllDestinations"
            />
            <label class="form-check-label" for="selectAllDestinations">
              Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡Ù…
            </label>
          </div>

          <!-- Destination Checkboxes -->
          <div
            id="destinationsBox"
            class="row border rounded p-3"
            style="max-height: 250px; overflow-y: auto"
          ></div>
        
</form>
           <script>
      const token = localStorage.getItem("token");
      if (!token) location.href = "login.html";

       let isDirty = false;

  // watch all inputs, selects, textareas
  document.querySelectorAll("input, textarea, select").forEach(el => {
    el.addEventListener("change", () => {
      isDirty = true;
    });
  });

   document.getElementById("backBtn").addEventListener("click", async function (e) {
  if (!isDirty) return;

  e.preventDefault();

  const wantsSave = confirm(
    "Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­ÙØ¸ Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ"
  );

  if (wantsSave) {
    try {
      await saveDocument();   //  SAME SAVE FUNCTION
      isDirty = false;
      window.location.href = this.href;
    } catch (err) {
      alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ØŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬");
    }
  } else {
    window.location.href = this.href;
  }
});

  window.addEventListener("beforeunload", function (e) {
    if (!isDirty) return;

    e.preventDefault();
    e.returnValue = "";
  });

      document
        .getElementById("selectAllDestinations")
        .addEventListener("change", function () {
          const checked = this.checked;
          document.querySelectorAll(".dest-check").forEach((cb) => {
            cb.checked = checked;
          });
        });

      const urlParams = new URLSearchParams(window.location.search);
      const docId = urlParams.get("id");

      let userGroupId = null;

      // Fetch current user info
      fetch("/api/users/me", { headers: { Authorization: "Bearer " + token } })
        .then((res) => res.json())
        .then((user) => {
          userGroupId = user.group_id;
          if (docId) {
            loadDraft(docId);
          } else {
            loadGroups(); // normal creation
          }
        });

      function updateSelectAll() {
        const all = document.querySelectorAll(".dest-check");
        const checked = document.querySelectorAll(".dest-check:checked");
        document.getElementById("selectAllDestinations").checked =
          all.length > 0 && all.length === checked.length;
      }

      function chunkArray(arr, size) {
        const result = [];
        for (let i = 0; i < arr.length; i += size) {
          result.push(arr.slice(i, i + size));
        }
        return result;
      }

      function loadGroups() {
        fetch("/api/users/groups", {
          headers: { Authorization: "Bearer " + token },
        })
          .then((res) => res.json())
          .then((groups) => {
            // Exclude current user's group
            const filtered = groups.filter((g) => g.id != userGroupId);

            // Sort by id ascending
            filtered.sort((a, b) => a.id - b.id);

            // Split into columns with 5 rows each
            const rowsPerColumn = 5; // 5 rows max per column
            const columns = chunkArray(filtered, rowsPerColumn);

            const box = document.getElementById("destinationsBox");
            box.innerHTML = "";

            columns.forEach((col) => {
              let colHtml = `<div class="col-12 col-sm-6 col-md-2">`; // 5 columns

              col.forEach((g) => {
                colHtml += `
            <div class="form-check">
              <input class="form-check-input dest-check"
                     type="checkbox"
                     value="${g.id}"
                     id="group_${g.id}">
              <label class="form-check-label" for="group_${g.id}">
                ${g.name}
              </label>
            </div>
          `;
              });

              colHtml += `</div>`;
              box.innerHTML += colHtml;
            });

            updateSelectAll();
          });
      }

function authHeaders(extra = {}) {
  return {
    Authorization: "Bearer " + token,
    ...extra
  };
}


function openFile(id, ext) {
  const token = localStorage.getItem("token");

  fetch(`/api/documents/${id}/file`, {
    headers: {
      "Authorization": "Bearer " + token
    }
  })
    .then(res => res.blob())
    .then(blob => {
      const url = URL.createObjectURL(blob);

      // Create a temporary link
      const a = document.createElement("a");
      a.href = url;
      a.download = `file.${ext}`; // ğŸ‘ˆ give the file its correct extension
      document.body.appendChild(a);
      a.click();

      // Cleanup
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    })
    .catch(err => {
      alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù");
      console.error(err);
    });
}

      function loadDraft(id) {
        fetch(`/api/documents/${id}`, {
          headers: authHeaders(),
        })
          .then((res) => res.json())
          .then((doc) => {
            console.log("Draft:", doc);
            document.getElementById("title").value = doc.title;
            document.getElementById("content").value = doc.content;
            document.getElementById("doc_num").value = doc.doc_num;
            document.getElementById("doc_date").value = doc.doc_date;
            document.getElementById("number_papers").value = doc.number_papers;
            document.getElementById("send_paper").checked = !!doc.send_paper;
            document.getElementById("send_electronic").checked = !!doc.send_electronic;
            document.getElementById("remarks").value = doc.remarks;

            // âœ… Display existing file
 if (doc.has_file) {
  console.log("Document has file");
  document.getElementById("existingFile").innerHTML = `
    <button type="button" class="btn btn-info mt-2" onclick="openFile('${doc.id}','${doc.doc_ext}')">
  Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
</button>
  `;
}

//     </button>
            // Normalize destination IDs
            let selectedIds = [];
            if (Array.isArray(doc.destinations)) {
              if (typeof doc.destinations[0] === "object") {
                selectedIds = doc.destinations.map((d) => d.id);
              } else {
                selectedIds = doc.destinations;
              }
            }

            // Fetch all groups
            fetch("/api/users/groups", {
              headers: { Authorization: "Bearer " + token },
            })
              .then((res) => res.json())
              .then((groups) => {
                // Exclude current user's group
                const filtered = groups.filter((g) => g.id != userGroupId);

                // Sort by id ascending
                filtered.sort((a, b) => a.id - b.id);

                // Split into columns with 5 rows each
                const rowsPerColumn = 5;
                const columns = chunkArray(filtered, rowsPerColumn);

                const box = document.getElementById("destinationsBox");
                box.innerHTML = "";

                columns.forEach((col) => {
                  let colHtml = `<div class="col-12 col-sm-6 col-md-2">`; // 5 columns

                  col.forEach((g) => {
                    const isChecked = selectedIds.includes(g.id);

                    colHtml += `
                <div class="form-check">
                  <input class="form-check-input dest-check"
                         type="checkbox"
                         value="${g.id}"
                         id="group_${g.id}"
                         ${isChecked ? "checked" : ""}>
                  <label class="form-check-label" for="group_${g.id}">
                    ${g.name}
                  </label>
                </div>
              `;
                  });

                  colHtml += `</div>`;
                  box.innerHTML += colHtml;
                });

                updateSelectAll();
              });
          });
      }

      async function saveDocument() {
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();
  const doc_num = document.getElementById("doc_num").value.trim();
  const doc_date = document.getElementById("doc_date").value.trim();
  const send_paper = document.getElementById("send_paper").checked ? 1 : 0;
const send_electronic = document.getElementById("send_electronic").checked ? 1 : 0;
  const remarks = document.getElementById("remarks").value.trim();
  
  const number_papers = document
    .getElementById("number_papers")
    .value.trim();

  const destinations = Array.from(
    document.querySelectorAll(".dest-check:checked")
  ).map((ch) => ch.value);

  const formData = new FormData();

  if (docId) formData.append("id", docId);

  formData.append("title", title);
  formData.append("content", content);
  formData.append("doc_num", doc_num);
  formData.append("doc_date", doc_date);
  formData.append("number_papers", number_papers);
  formData.append("destinations", destinations);
  formData.append("send_paper", send_paper ? "true" : "false");
  formData.append("send_electronic", send_electronic ? "true" : "false");
  formData.append("remarks", remarks);

  const fileInput = document.getElementById("attachment");
  const file = fileInput.files[0];
  if (file) {
    formData.append("attachment", file);
  }

  const res = await fetch("/api/documents/save", {
    method: "POST",
    headers: authHeaders(), // âš ï¸ must NOT set Content-Type manually
    body: formData,
  });

  const msg = await res.json();

  if (!res.ok) {
    throw new Error(msg.message || "Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯");
  }

  show("successBox", msg.message);
  return true;
}
      document.getElementById("docForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  try {
    await saveDocument();
    isDirty = false;
    if (!docId) document.getElementById("docForm").reset();
  } catch (err) {
    show("errorBox", err.message);
  }
});

      function show(id, text) {
        const box = document.getElementById(id);
        box.innerText = text;
        box.classList.remove("d-none");
        setTimeout(() => box.classList.add("d-none"), 3500);
      }
    </script>
  </body>
</html>
