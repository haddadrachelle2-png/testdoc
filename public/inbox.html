<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>البريد الوارد</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css"
      rel="stylesheet"
    />

    <style>
      #pagination button {
        padding: 6px 12px;
        margin: 0 5px;
        font-size: 14px;
        cursor: pointer;
      }

      #pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #page-info {
        font-weight: bold;
        margin: 0 10px;
      }
    </style>
  </head>
  <body class="p-4">
    <div class="container">
      <h3>البريد الوارد</h3>

      <!-- Search Filters -->
      <div class="row mb-3">
        <div class="col-md-3">
          <label>تاريخ البدء</label>
          <input type="date" id="startDate" class="form-control" />
        </div>
        <div class="col-md-3">
          <label>تاريخ الانتهاء</label>
          <input type="date" id="endDate" class="form-control" />
        </div>
        <div class="col-md-3 align-self-end">
          <button id="searchBtn" class="btn btn-primary">بحث</button>
        </div>
      </div>

      <!-- Action Button -->
      <div class="mb-3 d-flex justify-content-between">
        <button id="markBtn" class="btn btn-success">
          وضع علامة على المحدد كمقروء
        </button>
        <a href="index.html" class="btn btn-secondary"
          >⬅ العودة إلى لوحة التحكم</a
        >
      </div>

      <!-- Inbox Table -->
      <table class="table table-bordered mt-2">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" /></th>
            <th>الموضوع</th>
            <th>المحتوى</th>
            <th>تاريخ الإنشاء</th>
            <th>مرسل من قبل</th>
            <!-- <th>Received</th> -->
            <th>المرسل إليه</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="inboxTable"></tbody>
      </table>
    </div>

    <div id="pagination" style="text-align: center; margin-top: 20px">
      <button id="prev-btn">السابق</button>
      <span
        >صفحة
        <input
          type="number"
          id="page-input"
          style="width: 50px; text-align: center"
          min="1"
        />
        من <span id="total-pages">1</span></span
      >
      <button id="next-btn">التالي</button>
    </div>
<script>
  const token = localStorage.getItem("token");
  if (!token) location.href = "login.html";

  const inboxTable = document.getElementById("inboxTable");

  // --- Pagination Variables ---
  let currentPage = 1;
  let totalPages = 1;

  // Load inbox with optional date filter + pagination
  async function loadInbox(page = 1) {
    currentPage = page;

    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;

    let url = `/api/documents/inbox?page=${page}`;
    const params = [];

    if (start) params.push(`start=${start}`);
    if (end) params.push(`end=${end}`);

    if (params.length) url += "&" + params.join("&");

    const res = await fetch(url, {
      headers: { Authorization: "Bearer " + token },
    });

    const data = await res.json();
    console.log(data);

    // BACKEND MUST RETURN:
    // { data: [...], page: 1, total_pages: 5 }

    const inbox = data.data;
    totalPages = data.total_pages;

    // Update pagination info
    document.getElementById("total-pages").innerText = totalPages;
    document.getElementById("page-input").value = currentPage;

    document.getElementById("prev-btn").disabled = currentPage <= 1;
    document.getElementById("next-btn").disabled = currentPage >= totalPages;

    // Load table
    inboxTable.innerHTML = "";
// ${d.is_received ? "disabled" : ""}
    inbox.forEach((d) => {
      inboxTable.innerHTML += `
        <tr>
            <td><input type="checkbox" class="inboxCheckbox" value="${d.id}" ></td>
            <td>${d.title}</td>
            <td>${d.content}</td>
            <td>${new Date(d.created_at).toLocaleString()}</td>
            <td>${d.senderName}</td>
            <td>${d.destinations || "N/A"}</td>
            <td>${d.is_received || d.is_admin_group ? "موافق عليه" : "قيد الانتظار"}</td>
           
        </tr>
      `;
    });
  }

        // <td>
            //     <button onclick="viewDoc(${d.id})" class="btn btn-sm btn-primary">View</button>
            // </td>
  // Search Button
  document.getElementById("searchBtn").addEventListener("click", () => loadInbox(1));

  // Pagination Buttons
  document.getElementById("prev-btn").addEventListener("click", () => {
    if (currentPage > 1) loadInbox(currentPage - 1);
  });

  document.getElementById("next-btn").addEventListener("click", () => {
    if (currentPage < totalPages) loadInbox(currentPage + 1);
  });

  // Page number textbox
  document.getElementById("page-input").addEventListener("change", (e) => {
    let p = parseInt(e.target.value);
    if (p >= 1 && p <= totalPages) loadInbox(p);
    else e.target.value = currentPage; // reset if invalid
  });

  // Select All
  document.getElementById("selectAll").addEventListener("change", (e) => {
    document.querySelectorAll(".inboxCheckbox").forEach((cb) => {
      if (!cb.disabled) cb.checked = e.target.checked;
    });
  });

  // Mark Selected as Seen
  document.getElementById("markBtn").addEventListener("click", async () => {
    const selected = Array.from(
      document.querySelectorAll(".inboxCheckbox:checked")
    ).map((cb) => cb.value);

    if (selected.length === 0) {
      alert("Select at least one document");
      return;
    }

    const res = await fetch("/api/documents/markseen", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token,
      },
      body: JSON.stringify({ inboxIds: selected }),
    });

    const msg = await res.json();
    alert(msg.message || "Updated");
    loadInbox(currentPage);
  });

  function viewDoc(id) {
    window.location.href = `view-document.html?id=${id}`;
  }

  // Initial load
  loadInbox();
</script>
</body>
</html>
